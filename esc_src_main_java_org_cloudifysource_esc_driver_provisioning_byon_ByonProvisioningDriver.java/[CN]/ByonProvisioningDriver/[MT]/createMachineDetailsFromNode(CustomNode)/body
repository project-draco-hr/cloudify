{
  final ComputeTemplate template=this.cloud.getCloudCompute().getTemplates().get(this.cloudTemplateName);
  final MachineDetails md=createMachineDetailsForTemplate(template);
  md.setMachineId(node.getId());
  md.setPrivateAddress(node.getPrivateIP());
  md.setPublicAddress(node.getPublicIP());
  md.setCleanRemoteDirectoryOnStart(this.cleanRemoteDirectoryOnStart);
  if (!StringUtils.isBlank(node.getUsername()) && !StringUtils.isBlank(node.getCredential())) {
    md.setRemoteUsername(node.getUsername());
    md.setRemotePassword(node.getCredential());
  }
 else   if (!StringUtils.isBlank(template.getUsername()) && !StringUtils.isBlank(template.getPassword())) {
    md.setRemoteUsername(template.getUsername());
    md.setRemotePassword(template.getPassword());
  }
 else {
    final String nodeStr=node.toString();
    logger.severe("Cloud node loading failed, missing credentials for server: " + nodeStr);
    publishEvent("prov_node_loading_failed",nodeStr);
    throw new CloudProvisioningException("Cloud node loading failed, missing credentials for server: " + nodeStr);
  }
  return md;
}
