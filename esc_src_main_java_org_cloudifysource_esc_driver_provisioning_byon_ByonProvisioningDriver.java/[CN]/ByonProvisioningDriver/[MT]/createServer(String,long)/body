{
  final CustomNode node;
  final MachineDetails machineDetails;
  logger.info("Cloudify Deployer is creating a machine named: " + serverName + ". This may take a few minutes");
  node=deployer.createServer(cloudTemplateName,serverName);
  machineDetails=createMachineDetailsFromNode(node);
  try {
    handleServerCredentials(machineDetails);
  }
 catch (  final CloudProvisioningException e) {
    deployer.invalidateServer(cloudTemplateName,node,true);
    throw e;
  }
  try {
    Utils.validateConnection(machineDetails.getIp(),CloudifyConstants.SSH_PORT);
  }
 catch (  final Exception e) {
    logger.log(Level.SEVERE,"Cloud server could not be started on " + machineDetails.getIp() + ", SSH connection failed.",e);
    try {
      deployer.invalidateServer(cloudTemplateName,node,false);
    }
 catch (    final CloudProvisioningException ie) {
      logger.log(Level.SEVERE,"Failed to mark machine " + machineDetails.getIp() + " as Invalid.",ie);
    }
    throw new CloudProvisioningException(e);
  }
  if (System.currentTimeMillis() > endTime) {
    throw new TimeoutException();
  }
  logger.info("Machine successfully allocated");
  return machineDetails;
}
