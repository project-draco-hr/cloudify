{
  CustomNode node=null;
  if (org.apache.commons.lang.StringUtils.isBlank(serverName)) {
    throw new InstallerException("Failed to start cloud node, server name is missing");
  }
  final Map<String,List<CustomNode>> templateLists=nodesListsByTemplates.get(templateName);
  final List<CustomNode> freeNodesPool=templateLists.get(NODES_LIST_FREE);
  final List<CustomNode> allocatedNodesPool=templateLists.get(NODES_LIST_ALLOCATED);
  if (freeNodesPool.size() == 0) {
    throw new InstallerException("Failed to create new cloud node, all nodes are currently used");
  }
  node=freeNodesPool.iterator().next();
  if (!allocatedNodesPool.contains(node)) {
    allocatedNodesPool.add(node);
  }
  freeNodesPool.remove(node);
  ((CustomNodeImpl)node).setNodeName(serverName);
  return node;
}
