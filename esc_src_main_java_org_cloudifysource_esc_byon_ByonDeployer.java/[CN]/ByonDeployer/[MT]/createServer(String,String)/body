{
  CustomNode node=null;
  if (org.apache.commons.lang.StringUtils.isBlank(serverName)) {
    throw new CloudProvisioningException("Failed to create new cloud node, server name is missing");
  }
  final Map<String,List<CustomNode>> templateLists=nodesListsByTemplates.get(templateName);
  if (templateLists == null || templateLists.size() == 0) {
    throw new CloudProvisioningException("Failed to create new cloud node. \"" + templateName + "\" is not a known template.");
  }
  final List<CustomNode> freeNodesPool=templateLists.get(NODES_LIST_FREE);
  final List<CustomNode> allocatedNodesPool=templateLists.get(NODES_LIST_ALLOCATED);
  final List<CustomNode> invalidNodesPool=templateLists.get(NODES_LIST_INVALID);
  if (freeNodesPool.size() == 0 && invalidNodesPool.size() == 0) {
    throw new CloudProvisioningException("Failed to create a new cloud node for template \"" + templateName + "\", all available nodes are currently used");
  }
  if (freeNodesPool.size() > 0) {
    node=freeNodesPool.iterator().next();
    if (!allocatedNodesPool.contains(node)) {
      allocatedNodesPool.add(node);
    }
    freeNodesPool.remove(node);
  }
 else {
    if (invalidNodesPool.size() > 0) {
      CustomNode currentNode=null;
      final Iterator<CustomNode> nodesIterator=invalidNodesPool.iterator();
      while (nodesIterator.hasNext()) {
        currentNode=nodesIterator.next();
        try {
          Utils.validateConnection(currentNode.getPrivateIP(),CloudifyConstants.SSH_PORT);
          if (!allocatedNodesPool.contains(node)) {
            allocatedNodesPool.add(node);
          }
          invalidNodesPool.remove(node);
          break;
        }
 catch (        final Exception ex) {
        }
      }
    }
  }
  ((CustomNodeImpl)node).setNodeName(serverName);
  return node;
}
