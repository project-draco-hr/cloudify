{
  long end=System.currentTimeMillis() + timeunit.toMillis(timeout);
  int serviceShutDownEventsCount=0;
  String pollingURL="processingUnits/Names/" + ServiceUtils.getAbsolutePUName(applicationName,serviceName);
  waitForServicePU(applicationName,serviceName,pollingURL,timeoutErrorMessage,PROCESSINGUNIT_LOOKUP_TIMEOUT,TimeUnit.SECONDS);
  logger.info(MessageFormat.format(messages.getString("deploying_service"),serviceName));
  int currentNumberOfNonUSMInstances=-1;
  int currentNumberOfRunningUSMInstances=-1;
  boolean statusChanged=false;
  while (System.currentTimeMillis() < end) {
    Map<String,Object> serviceStatusMap=client.getAdminData(pollingURL);
    if ("partitioned-sync2backup".equals(serviceStatusMap.get("ClusterSchema"))) {
      plannedNumberOfInstances=Integer.valueOf((String)serviceStatusMap.get("TotalNumberOfInstances"));
    }
    if (!serviceStatusMap.get("Instances-Size").equals(0) && isUSMService(applicationName,serviceName)) {
      int actualNumberOfUSMServicesWithRunningState=getNumberOfUSMServicesWithRunningState(serviceName,applicationName,(Integer)serviceStatusMap.get("Instances-Size"));
      if (currentNumberOfRunningUSMInstances != actualNumberOfUSMServicesWithRunningState && actualNumberOfUSMServicesWithRunningState != 0) {
        currentNumberOfRunningUSMInstances=actualNumberOfUSMServicesWithRunningState;
        statusChanged=true;
      }
 else {
        statusChanged=false;
      }
    }
 else {
      int actualNumberOfInstances=(Integer)serviceStatusMap.get("Instances-Size");
      if (actualNumberOfInstances != currentNumberOfNonUSMInstances && actualNumberOfInstances != 0) {
        currentNumberOfNonUSMInstances=actualNumberOfInstances;
        statusChanged=true;
      }
 else {
        statusChanged=false;
      }
    }
    serviceShutDownEventsCount=handleEventLogs(serviceName,applicationName,plannedNumberOfInstances,serviceShutDownEventsCount);
    if ((Integer)serviceStatusMap.get("Instances-Size") == 0) {
      printStatusMessage(plannedNumberOfInstances,(Integer)serviceStatusMap.get("Instances-Size"),statusChanged);
    }
 else     if (plannedNumberOfInstances < currentNumberOfNonUSMInstances || plannedNumberOfInstances < currentNumberOfRunningUSMInstances) {
      throw new CLIException(MessageFormat.format(messages.getString("number_of_instances_exceeded_planned"),plannedNumberOfInstances,Math.max(currentNumberOfNonUSMInstances,currentNumberOfRunningUSMInstances)));
    }
 else     if ((Integer)serviceStatusMap.get("Instances-Size") > 0) {
      if (isUSMService(applicationName,serviceName)) {
        currentNumberOfRunningUSMInstances=getNumberOfUSMServicesWithRunningState(serviceName,applicationName,(Integer)serviceStatusMap.get("Instances-Size"));
        printStatusMessage(plannedNumberOfInstances,currentNumberOfRunningUSMInstances,statusChanged);
        if (currentNumberOfRunningUSMInstances == plannedNumberOfInstances) {
          return true;
        }
      }
 else {
        printStatusMessage(plannedNumberOfInstances,currentNumberOfNonUSMInstances,statusChanged);
        if (plannedNumberOfInstances == currentNumberOfNonUSMInstances) {
          return true;
        }
      }
    }
    Thread.sleep(POLLING_INTERVAL);
  }
  throw new TimeoutException(timeoutErrorMessage);
}
