{
  final String serverId=createServer(token,serverTemplate);
  try {
    final MachineDetails md=new MachineDetails();
    waitForServerToReachStatus(md,endTime,serverId,token,MACHINE_STATUS_ACTIVE);
    final Node node=this.getNode(serverId,token);
    md.setPublicAddress(node.getPublicIp());
    md.setMachineId(serverId);
    md.setAgentRunning(false);
    md.setCloudifyInstalled(false);
    md.setInstallationDirectory(serverTemplate.getRemoteDirectory());
    md.setRemoteUsername(serverTemplate.getUsername());
    return md;
  }
 catch (  final Exception e) {
    logger.log(Level.WARNING,"server: " + serverId + " failed to start up correctly. "+ "Shutting it down. Error was: "+ e.getMessage(),e);
    try {
      terminateServer(serverId,token,endTime);
    }
 catch (    final Exception e2) {
      logger.log(Level.WARNING,"Error while shutting down failed machine: " + serverId + ". Error was: "+ e.getMessage()+ ".It may be leaking.",e);
    }
    throw e;
  }
}
