{
  final Service service=getUsmLifecycleBean().getConfiguration().getService();
  final String storageTemplateName=service.getStorage().getTemplate();
  if (StringUtils.isNotBlank(storageTemplateName)) {
    try {
      logger.info("Allocating static storage for service " + getUsmLifecycleBean().getConfiguration().getServiceContext());
      final StorageFacade storage=getUsmLifecycleBean().getConfiguration().getServiceContext().getStorage();
      final StorageTemplate storageTemplate=storage.getTemplate(storageTemplateName);
      String deviceName=storageTemplate.getDeviceName();
      getUsmLifecycleBean().log("Allocating storage with size " + storageTemplate.getSize() + "GB");
      final ServiceVolume serviceVolume=getServiceVolumeFromSpace(getUsmLifecycleBean().getConfiguration().getServiceContext());
      if (serviceVolume == null) {
        logger.fine("service volume is null. this means it hasn't been created yet.");
        getUsmLifecycleBean().log("Creating volume");
        final String id=storage.createVolume(storageTemplateName);
        getUsmLifecycleBean().log("Volume created with id " + id);
        final ServiceVolume newServiceVolume=managementSpace.readById(ServiceVolume.class,id);
        logger.fine("Flagging service volume with id " + id + " to be static storage.");
        managementSpace.change(newServiceVolume,new ChangeSet().set("dynamic",false));
        getUsmLifecycleBean().log("Attaching volume to device " + deviceName);
        storage.attachVolume(id,deviceName);
        if (storageTemplate.isPartitioningRequired()) {
          getUsmLifecycleBean().log("Partitioning volume at " + deviceName);
          storage.partition(deviceName);
        }
        getUsmLifecycleBean().log("Formatting volume to filesystem " + storageTemplate.getFileSystemType());
        storage.format(deviceName,storageTemplate.getFileSystemType());
        getUsmLifecycleBean().log("Mounting volume to " + storageTemplate.getPath());
        storage.mount(deviceName,storageTemplate.getPath());
      }
 else {
        logger.fine("Detected an existing volume for this service upon allocation. found in state : " + serviceVolume.getState());
switch (serviceVolume.getState()) {
case CREATED:
          getUsmLifecycleBean().log("Attaching volume to device " + deviceName);
        storage.attachVolume(serviceVolume.getId(),deviceName);
case ATTACHED:
      if (storageTemplate.isPartitioningRequired()) {
        getUsmLifecycleBean().log("Partitioning volume at " + deviceName);
        storage.partition(deviceName);
      }
case PARTITIONED:
    getUsmLifecycleBean().log("Formatting volume to filesystem " + storageTemplate.getFileSystemType());
  storage.format(deviceName,storageTemplate.getFileSystemType());
case FORMATTED:
getUsmLifecycleBean().log("Mounting volume to " + storageTemplate.getPath());
storage.mount(deviceName,storageTemplate.getPath());
case MOUNTED:
break;
default :
throw new IllegalStateException("Unexpected state of service volume : " + serviceVolume.getState());
}
}
}
 catch (final Exception e) {
getUsmLifecycleBean().log("Storage allocation failed : " + e.getMessage());
if (e instanceof TimeoutException) {
throw (TimeoutException)e;
}
throw new USMException(e);
}
}
}
