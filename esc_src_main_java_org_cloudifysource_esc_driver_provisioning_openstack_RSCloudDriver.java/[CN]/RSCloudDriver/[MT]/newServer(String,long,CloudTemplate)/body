{
  final MachineDetails md=createServer(token,serverTemplate);
  try {
    waitForServerToReachStatus(md,endTime,md.getMachineId(),token,"ACTIVE");
    md.setAgentRunning(false);
    md.setCloudifyInstalled(false);
    md.setInstallationDirectory(cloud.getProvider().getRemoteDirectory());
    return md;
  }
 catch (  final Exception e) {
    logger.log(Level.WARNING,"server: " + md.getMachineId() + " failed to start up correctly. "+ "Shutting it down. Error was: "+ e.getMessage(),e);
    try {
      terminateServer(md.getMachineId(),token,endTime);
    }
 catch (    final Exception e2) {
      logger.log(Level.WARNING,"Error while shutting down failed machine: " + md.getMachineId() + ". Error was: "+ e.getMessage()+ ".It may be leaking.",e);
    }
    throw e;
  }
}
