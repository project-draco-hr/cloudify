{
  final String scriptFileName=getScriptFileName(details);
  String remoteDirectory=details.getRemoteDir();
  if (remoteDirectory.endsWith("/")) {
    remoteDirectory=remoteDirectory.substring(0,remoteDirectory.length() - 1);
  }
  if (details.isLus()) {
    remoteDirectory=remoteDirectory + "/" + details.getRelativeLocalDir();
  }
  final String scriptPath=remoteDirectory + "/" + scriptFileName;
  final ShellCommandBuilder scb=new ShellCommandBuilder(details.getRemoteExecutionMode()).exportVar(LUS_IP_ADDRESS_ENV,details.getLocator()).exportVar(GSA_MODE_ENV,details.isLus() ? "lus" : "agent").exportVar(CloudifyConstants.SPRING_ACTIVE_PROFILE_ENV_VAR,CloudifyConstants.SPRING_BEANS_PROFILE_DEFAULT).exportVar(NO_WEB_SERVICES_ENV,details.isNoWebServices() ? "true" : "false").exportVar(MACHINE_IP_ADDRESS_ENV,details.isBindToPrivateIp() ? details.getPrivateIp() : details.getPublicIp()).exportVar(MACHINE_ZONES_ENV,details.getZones()).exportVar(CLOUDIFY_LINK_ENV,details.getCloudifyUrl() != null ? "\"" + details.getCloudifyUrl() + "\"" : "").exportVar(CLOUDIFY_OVERRIDES_LINK_ENV,details.getOverridesUrl() != null ? "\"" + details.getOverridesUrl() + "\"" : "").exportVar(WORKING_HOME_DIRECTORY_ENV,remoteDirectory).exportVar(CloudifyConstants.GIGASPACES_AGENT_ENV_PRIVATE_IP,details.getPrivateIp()).exportVar(CloudifyConstants.GIGASPACES_AGENT_ENV_PUBLIC_IP,details.getPublicIp()).exportVar(CloudifyConstants.GIGASPACES_CLOUD_TEMPLATE_NAME,details.getTemplateName()).exportVar(CloudifyConstants.CLOUDIFY_AGENT_ENV_PRIVATE_IP,details.getPrivateIp()).exportVar(CloudifyConstants.CLOUDIFY_AGENT_ENV_PUBLIC_IP,details.getPublicIp());
  if (details.getReservationId() != null) {
    scb.exportVar(GSA_RESERVATION_ID_ENV,details.getReservationId().toString());
  }
  if (details.isLus()) {
    String remotePath=details.getRemoteDir();
    if (!remotePath.endsWith("/")) {
      remotePath+="/";
    }
    scb.exportVar(CLOUD_FILE,remotePath + details.getCloudFile().getName());
  }
  if (details.getUsername() != null) {
    scb.exportVar("USERNAME",details.getUsername());
  }
  if (details.getPassword() != null) {
    scb.exportVar("PASSWORD",details.getPassword());
  }
  final Set<Entry<String,String>> entries=details.getExtraRemoteEnvironmentVariables().entrySet();
  for (  final Entry<String,String> entry : entries) {
    scb.exportVar(entry.getKey(),entry.getValue());
  }
  scb.chmodExecutable(scriptPath).call(scriptPath);
  final String command=scb.toString();
  logger.fine("Calling startup script on target: " + targetHost + " with LOCATOR="+ details.getLocator()+ "\nThis may take a few minutes");
switch (details.getRemoteExecutionMode()) {
case SSH:
    sshCommand(targetHost,command,details.getUsername(),details.getPassword(),details.getKeyFile(),Utils.millisUntil(end),TimeUnit.MILLISECONDS);
  break;
case WINRM:
powershellCommand(targetHost,command,details.getUsername(),details.getPassword(),details.getKeyFile(),Utils.millisUntil(end),TimeUnit.MILLISECONDS,details.getLocalDir());
break;
default :
throw new UnsupportedOperationException();
}
}
