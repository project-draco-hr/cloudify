{
  final String scriptFileName=getScriptFileName(details);
  String remoteDirectory=details.getRemoteDir();
  if (remoteDirectory.endsWith("/")) {
    remoteDirectory=remoteDirectory.substring(0,remoteDirectory.length() - 1);
  }
  if (details.isLus()) {
    remoteDirectory=remoteDirectory + "/" + details.getRelativeLocalDir();
  }
  final String scriptPath=remoteDirectory + "/" + scriptFileName;
  String authGroups=null;
  if (details.getAuthGroups() != null) {
    authGroups=details.getAuthGroups();
  }
  final ShellCommandBuilder scb=new ShellCommandBuilder(details.getRemoteExecutionMode()).exportVar(LUS_IP_ADDRESS_ENV,details.getLocator()).exportVar(GSA_MODE_ENV,details.isLus() ? "lus" : "agent").exportVar(CloudifyConstants.SPRING_ACTIVE_PROFILE_ENV_VAR,details.getSecurityProfile()).exportVar(NO_WEB_SERVICES_ENV,details.isNoWebServices() ? "true" : "false").exportVar(MACHINE_IP_ADDRESS_ENV,details.isBindToPrivateIp() ? details.getPrivateIp() : details.getPublicIp()).exportVar(MACHINE_ZONES_ENV,details.getZones()).exportVar(CloudifyConstants.CLOUDIFY_LINK_ENV,details.getCloudifyUrl() != null ? "\"" + details.getCloudifyUrl() + "\"" : "").exportVar(CloudifyConstants.CLOUDIFY_OVERRIDES_LINK_ENV,details.getOverridesUrl() != null ? "\"" + details.getOverridesUrl() + "\"" : "").exportVar(WORKING_HOME_DIRECTORY_ENV,remoteDirectory).exportVar(CloudifyConstants.GIGASPACES_AUTH_GROUPS,authGroups).exportVar(CloudifyConstants.GIGASPACES_AGENT_ENV_PRIVATE_IP,details.getPrivateIp()).exportVar(CloudifyConstants.GIGASPACES_AGENT_ENV_PUBLIC_IP,details.getPublicIp()).exportVar(CloudifyConstants.GIGASPACES_CLOUD_TEMPLATE_NAME,details.getTemplateName()).exportVar(CloudifyConstants.GIGASPACES_CLOUD_MACHINE_ID,details.getMachineId()).exportVar(CloudifyConstants.CLOUDIFY_CLOUD_MACHINE_ID,details.getMachineId()).exportVar(CloudifyConstants.CLOUDIFY_AGENT_ENV_PRIVATE_IP,details.getPrivateIp()).exportVar(CloudifyConstants.CLOUDIFY_AGENT_ENV_PUBLIC_IP,details.getPublicIp());
  if (details.getReservationId() != null) {
    scb.exportVar(GSA_RESERVATION_ID_ENV,details.getReservationId().toString());
  }
  if (details.isLus()) {
    String remotePath=details.getRemoteDir();
    if (!remotePath.endsWith("/")) {
      remotePath+="/";
    }
    scb.exportVar(CLOUD_FILE,remotePath + details.getCloudFile().getName());
    logger.log(Level.FINE,"Setting ESM/GSM/LUS/GSA/GSC java options");
    scb.exportVar("ESM_JAVA_OPTIONS",details.getEsmCommandlineArgs());
    scb.exportVar("LUS_JAVA_OPTIONS",details.getLusCommandlineArgs());
    scb.exportVar("GSM_JAVA_OPTIONS",details.getGsmCommandlineArgs());
    scb.exportVar("GSA_JAVA_OPTIONS",details.getGsaCommandlineArgs());
    scb.exportVar("GSC_JAVA_OPTIONS",details.getGscCommandlineArgs());
    scb.exportVar(CloudifyConstants.REST_PORT_ENV_VAR,details.getRestPort().toString());
    scb.exportVar(CloudifyConstants.REST_MAX_MEMORY_ENVIRONMENT_VAR,details.getRestMaxMemory());
    scb.exportVar(CloudifyConstants.WEBUI_PORT_ENV_VAR,details.getWebuiPort().toString());
    scb.exportVar(CloudifyConstants.WEBUI_MAX_MEMORY_ENVIRONMENT_VAR,details.getWebuiMaxMemory());
  }
  if (details.getUsername() != null) {
    scb.exportVar("USERNAME",details.getUsername());
  }
  if (details.getPassword() != null) {
    scb.exportVar("PASSWORD",details.getPassword());
  }
  scb.exportVar(CloudifyConstants.SPRING_SECURITY_CONFIG_FILE_ENV_VAR,details.getRemoteDir() + "/" + CloudifyConstants.SECURITY_FILE_NAME);
  if (StringUtils.isNotBlank(details.getKeystorePassword())) {
    scb.exportVar(CloudifyConstants.KEYSTORE_FILE_ENV_VAR,details.getRemoteDir() + "/" + CloudifyConstants.KEYSTORE_FILE_NAME);
    scb.exportVar(CloudifyConstants.KEYSTORE_PASSWORD_ENV_VAR,details.getKeystorePassword());
  }
  final Set<Entry<String,String>> entries=details.getExtraRemoteEnvironmentVariables().entrySet();
  for (  final Entry<String,String> entry : entries) {
    scb.exportVar(entry.getKey(),entry.getValue());
  }
  scb.chmodExecutable(scriptPath).call(scriptPath);
  final String command=scb.toString();
  logger.fine("Calling startup script on target: " + targetHost + " with LOCATOR="+ details.getLocator()+ "\nThis may take a few minutes. command is: "+ command);
switch (details.getRemoteExecutionMode()) {
case SSH:
    sshCommand(targetHost,command,details.getUsername(),details.getPassword(),details.getKeyFile(),CalcUtils.millisUntil(end),TimeUnit.MILLISECONDS);
  break;
case WINRM:
powershellCommand(targetHost,command,details.getUsername(),details.getPassword(),details.getKeyFile(),CalcUtils.millisUntil(end),TimeUnit.MILLISECONDS,details.getLocalDir());
break;
default :
throw new UnsupportedOperationException();
}
}
