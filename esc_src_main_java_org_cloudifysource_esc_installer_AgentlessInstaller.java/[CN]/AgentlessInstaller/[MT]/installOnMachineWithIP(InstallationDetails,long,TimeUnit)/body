{
  final long end=System.currentTimeMillis() + unit.toMillis(timeout);
  if (details.getLocator() == null) {
    details.setLocator(details.getPrivateIp());
  }
  logger.fine("Executing agentless installer with the following details:\n" + details.toString());
  final String sshIpAddress=details.isConnectedToPrivateIp() ? details.getPrivateIp() : details.getPublicIp();
  publishEvent("attempting_to_access_vm_with_ssh",sshIpAddress);
  checkConnection(sshIpAddress,SSH_PORT,Utils.millisUntil(end),TimeUnit.MILLISECONDS);
  try {
    final Set<String> excludedFiles=new HashSet<String>();
    if (!details.isLus() && details.getManagementOnlyFiles() != null) {
      excludedFiles.addAll(Arrays.asList(details.getManagementOnlyFiles()));
    }
    copyFiles(sshIpAddress,details.getUsername(),details.getPassword(),details.getLocalDir(),details.getRemoteDir(),details.getKeyFile(),excludedFiles,details.getCloudFile(),Utils.millisUntil(end),TimeUnit.MILLISECONDS);
  }
 catch (  final FileSystemException e) {
    throw new InstallerException("Uploading files to remote server failed.",e);
  }
catch (  final IOException e) {
    throw new InstallerException("Uploading files to remote server failed.",e);
  }
  String remoteDirectory=details.getRemoteDir();
  if (remoteDirectory.endsWith("/")) {
    remoteDirectory=remoteDirectory.substring(0,remoteDirectory.length() - 1);
  }
  final String scriptPath=remoteDirectory + "/" + STARTUP_SCRIPT_NAME;
  final ShellCommandBuilder scb=new ShellCommandBuilder().exportVar(LUS_IP_ADDRESS_ENV,details.getLocator()).exportVar(GSA_MODE_ENV,details.isLus() ? "lus" : "agent").exportVar(NO_WEB_SERVICES_ENV,details.isNoWebServices() ? "true" : "false").exportVar(MACHINE_IP_ADDRESS_ENV,(details.isBindToPrivateIp() ? details.getPrivateIp() : details.getPublicIp())).exportVar(MACHINE_ZONES_ENV,details.getZones()).exportVar(CLOUDIFY_LINK_ENV,details.getCloudifyUrl() != null ? "\"" + details.getCloudifyUrl() + "\"" : "").exportVar(CLOUDIFY_OVERRIDES_LINK_ENV,details.getOverridesUrl() != null ? "\"" + details.getOverridesUrl() + "\"" : "").exportVar(WORKING_HOME_DIRECTORY_ENV,remoteDirectory).exportVar(CloudifyConstants.CLOUDIFY_AGENT_ENV_PRIVATE_IP,details.getPrivateIp()).exportVar(CloudifyConstants.CLOUDIFY_AGENT_ENV_PUBLIC_IP,details.getPublicIp());
  if (details.isLus()) {
    String remotePath=details.getRemoteDir();
    if (!remotePath.endsWith("/")) {
      remotePath+="/";
    }
    scb.exportVar(CLOUD_FILE,remotePath + details.getCloudFile().getName());
  }
  scb.chmodExecutable(scriptPath).call(scriptPath);
  final String command=scb.toString();
  logger.fine("Calling startup script on target: " + sshIpAddress + " with LOCATOR="+ details.getLocator()+ "\nThis may take a few minutes");
  try {
    Utils.executeSSHCommand(sshIpAddress,command,details.getUsername(),details.getPassword(),details.getKeyFile(),Utils.millisUntil(end),TimeUnit.MILLISECONDS);
  }
 catch (  final BuildException e) {
    if (e instanceof BuildTimeoutException) {
      final TimeoutException ex=new TimeoutException("Command " + command + " failed to execute: "+ e.getMessage());
      ex.initCause(e);
      throw ex;
    }
 else     if (e instanceof ExitStatusException) {
      final ExitStatusException ex=(ExitStatusException)e;
      final int ec=ex.getStatus();
      throw new InstallerException("Command " + command + " failed with exit code: "+ ec,e);
    }
 else {
      throw new InstallerException("Command " + command + " failed to execute.",e);
    }
  }
  publishEvent("access_vm_with_ssh_success",details.getPublicIp());
}
