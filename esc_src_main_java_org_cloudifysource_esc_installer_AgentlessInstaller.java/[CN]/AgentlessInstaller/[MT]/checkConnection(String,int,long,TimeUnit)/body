{
  final long end=System.currentTimeMillis() + unit.toMillis(timeout);
  final InetAddress inetAddress=waitForRoute(ip,Math.min(end,System.currentTimeMillis() + DEFAULT_ROUTE_RESOLUTION_TIMEOUT));
  final InetSocketAddress socketAddress=new InetSocketAddress(inetAddress,port);
  logger.fine("Checking connection to: " + socketAddress);
  while (System.currentTimeMillis() + CONNECTION_TEST_SLEEP_BEFORE_RETRY_MILLIS < end) {
    Thread.sleep(CONNECTION_TEST_SLEEP_BEFORE_RETRY_MILLIS);
    final Socket sock=new Socket();
    try {
      sock.connect(socketAddress,CONNECTION_TEST_SOCKET_CONNECT_TIMEOUT_MILLIS);
      return;
    }
 catch (    final IOException e) {
      logger.log(Level.FINE,"Checking connection to: " + socketAddress,e);
    }
 finally {
      if (sock != null) {
        try {
          sock.close();
        }
 catch (        final IOException e) {
          logger.fine("Failed to close socket");
        }
      }
    }
  }
  throw new TimeoutException("Failed connecting to " + ip + ":"+ port);
}
