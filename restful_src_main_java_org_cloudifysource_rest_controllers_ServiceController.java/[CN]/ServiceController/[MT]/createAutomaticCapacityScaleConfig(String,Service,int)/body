{
  ScalingRulesDetails autoScaling=service.getScalingRules();
  if (service.getMinAllowedInstances() <= 0) {
    throw new DSLException("Minimum number of instances (" + service.getMinAllowedInstances() + ") must be 1 or higher.");
  }
  if (service.getMinAllowedInstances() > service.getMaxAllowedInstances()) {
    throw new DSLException("maximum number of instances (" + service.getMaxAllowedInstances() + ") must be equal or greater than the minimum number of instances ("+ service.getMinAllowedInstances()+ ")");
  }
  if (service.getMinAllowedInstances() > service.getNumInstances()) {
    throw new DSLException("number of instances (" + service.getNumInstances() + ") must be equal or greater than the minimum number of instances ("+ service.getMinAllowedInstances()+ ")");
  }
  if (service.getNumInstances() > service.getMaxAllowedInstances()) {
    throw new DSLException("number of instances (" + service.getNumInstances() + ") must be equal or less than the maximum number of instances ("+ service.getMaxAllowedInstances()+ ")");
  }
  ProcessingUnitStatisticsId statisticsId=new ProcessingUnitStatisticsId();
  statisticsId.setMonitor(CloudifyConstants.USM_MONITORS_SERVICE_ID);
  statisticsId.setMetric(autoScaling.getMetric());
  statisticsId.setInstancesStatistics(autoScaling.getInstancesStatistics().createInstancesStatistics());
  if (autoScaling.getMovingTimeRangeInSeconds() <= autoScaling.getSamplingPeriodInSeconds()) {
    if (logger.isLoggable(Level.FINE)) {
      logger.fine("Deploying service " + serviceName + " with auto scaling that monitors the last sample of "+ autoScaling.getMetric());
    }
    statisticsId.setTimeWindowStatistics(new LastSampleTimeWindowStatisticsConfig());
  }
 else {
    statisticsId.setTimeWindowStatistics(autoScaling.getTimeStatistics().createTimeWindowStatistics(autoScaling.getMovingTimeRangeInSeconds(),TimeUnit.SECONDS));
  }
  AutomaticCapacityScaleRuleConfig rule=new AutomaticCapacityScaleRuleConfig();
  rule.setStatistics(statisticsId);
  if (autoScaling.getLowThreshold() != null) {
    Comparable<?> threshold=autoScaling.getLowThreshold().getValue();
    if (threshold == null) {
      throw new DSLException("lowThreshold value is missing");
    }
    int instancesDecrease=autoScaling.getLowThreshold().getInstancesDecrease();
    if (instancesDecrease < 0) {
      throw new DSLException("lowThreshold instancesDecrease cannot be a negative number (" + instancesDecrease + ")");
    }
    if (instancesDecrease > 0) {
      rule.setLowThreshold(threshold);
      rule.setLowThresholdBreachedDecrease(new CapacityRequirementsConfigurer().memoryCapacity(instancesDecrease * externalProcessMemoryInMB,MemoryUnit.MEGABYTES).create());
    }
  }
  if (autoScaling.getHighThreshold() != null) {
    Comparable<?> threshold=autoScaling.getHighThreshold().getValue();
    if (threshold == null) {
      throw new DSLException("highThreshold value is missing");
    }
    int instancesIncrease=autoScaling.getHighThreshold().getInstancesIncrease();
    if (instancesIncrease < 0) {
      throw new DSLException("highThreshold instancesIncrease cannot be a negative number (" + instancesIncrease + ")");
    }
    if (instancesIncrease > 0) {
      rule.setHighThreshold(threshold);
      rule.setHighThresholdBreachedIncrease(new CapacityRequirementsConfigurer().memoryCapacity(instancesIncrease * externalProcessMemoryInMB,MemoryUnit.MEGABYTES).create());
    }
  }
  CapacityRequirementsConfig minCapacity=new CapacityRequirementsConfigurer().memoryCapacity((service.getMinAllowedInstances() * externalProcessMemoryInMB),MemoryUnit.MEGABYTES).create();
  CapacityRequirementsConfig initialCapacity=new CapacityRequirementsConfigurer().memoryCapacity((service.getNumInstances() * externalProcessMemoryInMB),MemoryUnit.MEGABYTES).create();
  CapacityRequirementsConfig maxCapacity=new CapacityRequirementsConfigurer().memoryCapacity((service.getMaxAllowedInstances() * externalProcessMemoryInMB),MemoryUnit.MEGABYTES).create();
  AutomaticCapacityScaleConfig scaleConfig=new AutomaticCapacityScaleConfigurer().minCapacity(minCapacity).initialCapacity(initialCapacity).maxCapacity(maxCapacity).statisticsPollingInterval(autoScaling.getSamplingPeriodInSeconds(),TimeUnit.SECONDS).cooldownAfterScaleOut(service.getScaleOutCooldownInSeconds(),TimeUnit.SECONDS).cooldownAfterScaleIn(service.getScaleInCooldownInSeconds(),TimeUnit.SECONDS).addRule(rule).create();
  return scaleConfig;
}
