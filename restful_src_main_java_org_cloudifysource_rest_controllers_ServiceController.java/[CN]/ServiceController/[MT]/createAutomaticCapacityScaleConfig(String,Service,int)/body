{
  ScalingRulesDetails scalingRule=service.getScalingRules();
  if (service.getMinAllowedInstances() <= 0) {
    throw new DSLException("Minimum number of instances (" + service.getMinAllowedInstances() + ") must be 1 or higher.");
  }
  if (service.getMinAllowedInstances() > service.getMaxAllowedInstances()) {
    throw new DSLException("maximum number of instances (" + service.getMaxAllowedInstances() + ") must be equal or greater than the minimum number of instances ("+ service.getMinAllowedInstances()+ ")");
  }
  if (service.getMinAllowedInstances() > service.getNumInstances()) {
    throw new DSLException("number of instances (" + service.getNumInstances() + ") must be equal or greater than the minimum number of instances ("+ service.getMinAllowedInstances()+ ")");
  }
  if (service.getNumInstances() > service.getMaxAllowedInstances()) {
    throw new DSLException("number of instances (" + service.getNumInstances() + ") must be equal or less than the maximum number of instances ("+ service.getMaxAllowedInstances()+ ")");
  }
  ProcessingUnitStatisticsId statisticsId=new ProcessingUnitStatisticsId();
  statisticsId.setMonitor(CloudifyConstants.USM_MONITORS_SERVICE_ID);
  statisticsId.setMetric(scalingRule.getMetric());
  statisticsId.setInstancesStatistics(scalingRule.getInstancesStatistics().createInstancesStatistics());
  if (scalingRule.getMovingTimeRangeInSeconds() <= scalingRule.getSamplingPeriodInSeconds()) {
    if (logger.isLoggable(Level.FINE)) {
      logger.fine("Deploying service " + serviceName + " with auto scaling that monitors the last sample of "+ scalingRule.getMetric());
    }
    statisticsId.setTimeWindowStatistics(new LastSampleTimeWindowStatisticsConfig());
  }
 else {
    statisticsId.setTimeWindowStatistics(scalingRule.getTimeStatistics().createTimeWindowStatistics(scalingRule.getMovingTimeRangeInSeconds(),TimeUnit.SECONDS));
  }
  AutomaticCapacityScaleRuleConfig rule=new AutomaticCapacityScaleRuleConfig();
  rule.setStatistics(statisticsId);
  if (scalingRule.getLowThreshold() == null) {
    if (logger.isLoggable(Level.FINE)) {
      logger.fine(serviceName + " scalingRule " + scalingRule.getMetric()+ " lowThreshold is undefined");
    }
  }
 else {
    Comparable<?> threshold=scalingRule.getLowThreshold().getValue();
    if (threshold == null) {
      throw new DSLException(serviceName + " scalingRule " + scalingRule.getMetric()+ " lowThreshold value is missing");
    }
    int instancesDecrease=scalingRule.getLowThreshold().getInstancesDecrease();
    if (instancesDecrease < 0) {
      throw new DSLException(serviceName + " scalingRule " + scalingRule.getMetric()+ " lowThreshold instancesDecrease cannot be a negative number ("+ instancesDecrease+ ")");
    }
    if (instancesDecrease == 0) {
      if (logger.isLoggable(Level.FINE)) {
        logger.fine(serviceName + " scalingRule " + scalingRule.getMetric()+ " lowThreshold instancesDecrease is 0");
      }
    }
 else {
      rule.setLowThreshold(threshold);
      rule.setLowThresholdBreachedDecrease(new CapacityRequirementsConfigurer().memoryCapacity(instancesDecrease * externalProcessMemoryInMB,MemoryUnit.MEGABYTES).create());
    }
  }
  if (scalingRule.getHighThreshold() == null) {
    if (logger.isLoggable(Level.FINE)) {
      logger.fine(serviceName + " scalingRule " + scalingRule.getMetric()+ " highThreshold is undefined");
    }
  }
 else {
    Comparable<?> threshold=scalingRule.getHighThreshold().getValue();
    if (threshold == null) {
      throw new DSLException(serviceName + " scalingRule " + scalingRule.getMetric()+ " highThreshold value is missing");
    }
    int instancesIncrease=scalingRule.getHighThreshold().getInstancesIncrease();
    if (instancesIncrease < 0) {
      throw new DSLException(serviceName + " scalingRule " + scalingRule.getMetric()+ " highThreshold instancesIncrease cannot be a negative number ("+ instancesIncrease+ ")");
    }
    if (instancesIncrease == 0) {
      if (logger.isLoggable(Level.FINE)) {
        logger.fine(serviceName + " scalingRule " + scalingRule.getMetric()+ " highThreshold instancesIncrease is 0");
      }
    }
 else {
      rule.setHighThreshold(threshold);
      rule.setHighThresholdBreachedIncrease(new CapacityRequirementsConfigurer().memoryCapacity(instancesIncrease * externalProcessMemoryInMB,MemoryUnit.MEGABYTES).create());
    }
  }
  CapacityRequirementsConfig minCapacity=new CapacityRequirementsConfigurer().memoryCapacity((service.getMinAllowedInstances() * externalProcessMemoryInMB),MemoryUnit.MEGABYTES).create();
  CapacityRequirementsConfig initialCapacity=new CapacityRequirementsConfigurer().memoryCapacity((service.getNumInstances() * externalProcessMemoryInMB),MemoryUnit.MEGABYTES).create();
  CapacityRequirementsConfig maxCapacity=new CapacityRequirementsConfigurer().memoryCapacity((service.getMaxAllowedInstances() * externalProcessMemoryInMB),MemoryUnit.MEGABYTES).create();
  AutomaticCapacityScaleConfig scaleConfig=new AutomaticCapacityScaleConfigurer().minCapacity(minCapacity).initialCapacity(initialCapacity).maxCapacity(maxCapacity).statisticsPollingInterval(scalingRule.getSamplingPeriodInSeconds(),TimeUnit.SECONDS).cooldownAfterScaleOut(service.getScaleOutCooldownInSeconds(),TimeUnit.SECONDS).cooldownAfterScaleIn(service.getScaleInCooldownInSeconds(),TimeUnit.SECONDS).addRule(rule).create();
  return scaleConfig;
}
