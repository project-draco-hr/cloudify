{
  if (cloud == null) {
    throw new RestErrorException("local_cloud_not_support_tempaltes","add-templates");
  }
  logger.log(Level.INFO,"addTemplates - starting add templates.");
  File localTemplateFolder=CloudTemplatesReader.unzipCloudTemplatesFolder(copyMultipartFileToLocalFile(templatesFolder));
  try {
    Map<String,Object> result=addTemplatesToCloud(localTemplateFolder);
    List<String> expectedTemplates=(List<String>)result.get(SUCCESSFULLY_ADDED_TEMPLATES_KEY);
    List<String> failedToAdd=(List<String>)result.get(FAILED_TO_ADD_TEMPLATES_KEY);
    Map<String,List<String>> failedToAddTemplatesByHost=new HashMap<String,List<String>>();
    if (!failedToAdd.isEmpty()) {
      logger.log(Level.WARNING,"addTemplatesInternal - Failed to add templates: " + failedToAdd.toString() + " from "+ localTemplateFolder.getAbsolutePath());
      failedToAddTemplatesByHost.put(InetAddress.getLocalHost().getHostName(),failedToAdd);
    }
    Map<String,List<String>> addedTemplatesByHost=new HashMap<String,List<String>>();
    addedTemplatesByHost.put(InetAddress.getLocalHost().getHostName(),expectedTemplates);
    sendAddTempaltesToRestInstances(templatesFolder,expectedTemplates,addedTemplatesByHost,failedToAddTemplatesByHost);
    if (!failedToAddTemplatesByHost.isEmpty()) {
      logger.log(Level.INFO,"Failed to add the following tempaltes: " + failedToAddTemplatesByHost + ". Successfully added templates (by host): "+ addedTemplatesByHost);
      throw new RestErrorException("failed_to_add_templates",localTemplateFolder.getAbsolutePath(),addedTemplatesByHost.toString(),failedToAddTemplatesByHost.toString());
    }
    logger.log(Level.INFO,"Successfully added templates: " + addedTemplatesByHost.toString());
    return successStatus(expectedTemplates);
  }
  finally {
    localTemplateFolder.delete();
  }
}
