{
  try {
    final MachineDetails md=this.createMachineDetailsForTemplate(template);
    md.setMachineId(server.getId());
    md.setCloudifyInstalled(false);
    md.setInstallationDirectory(null);
    md.setOpenFilesLimit(template.getOpenFilesLimit());
    final String prefix=this.securityGroupNames.getPrefix();
    if (this.computeNetworks == null) {
      Network managementNetwork=networkApi.getNetworkByName(this.managementNetworkName);
      if (managementNetwork == null) {
        managementNetwork=networkApi.getNetworkByName(prefix + this.managementNetworkName);
      }
      final Port managementPort=networkApi.getPort(server.getId(),managementNetwork.getId());
      final RouteFixedIp fixedIp=managementPort.getFixedIps().get(0);
      md.setPrivateAddress(fixedIp.getIpAddress());
      final FloatingIp floatingIp=networkApi.getFloatingIpByPortId(managementPort.getId());
      if (floatingIp != null) {
        md.setPublicAddress(floatingIp.getFloatingIpAddress());
      }
    }
 else {
      final String networkName=this.computeNetworks.get(0);
      final Network network=networkApi.getNetworkByName(networkName);
      final Port port=networkApi.getPort(server.getId(),network.getId());
      final RouteFixedIp fixedIp=port.getFixedIps().get(0);
      md.setPrivateAddress(fixedIp.getIpAddress());
    }
    if (!management && this.computeNetworks == null) {
      Network appliNetwork=networkApi.getNetworkByName(this.applicationNetworkName);
      if (appliNetwork == null) {
        appliNetwork=networkApi.getNetworkByName(prefix + this.applicationNetworkName);
      }
      final Port appliPort=networkApi.getPort(server.getId(),appliNetwork.getId());
      final RouteFixedIp appliFixedIp=appliPort.getFixedIps().get(0);
      Map<String,String> env=new HashMap<String,String>();
      env.put("CLOUDIFY_APPLICATION_NETWORK_IP",appliFixedIp.getIpAddress());
      md.setEnvironment(env);
    }
    this.handleServerCredentials(md,template);
    return md;
  }
 catch (  Exception e) {
    throw new CloudProvisioningException(e);
  }
}
