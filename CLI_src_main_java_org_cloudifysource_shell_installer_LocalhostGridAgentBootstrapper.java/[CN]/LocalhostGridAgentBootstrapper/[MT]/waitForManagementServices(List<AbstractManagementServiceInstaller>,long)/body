{
  final ConnectionLogsFilter connectionLogs=new ConnectionLogsFilter();
  connectionLogs.supressConnectionErrors();
  final Admin admin=createAdmin();
  try {
    setLookupDefaults(admin);
    GridServiceAgent agent=null;
    try {
      try {
        if (!isLocalCloud || fastExistingAgentCheck()) {
          agent=waitForExistingAgent(admin,ShellUtils.millisUntil(TIMEOUT_ERROR_MESSAGE,end),TimeUnit.MILLISECONDS);
        }
      }
 catch (      final Exception e) {
        throw new CLIValidationException(e,131,CloudifyErrorMessages.POST_BOOTSTRAP_NO_AGENT_FOUND.getName());
      }
    }
  finally {
      connectionLogs.restoreConnectionErrors();
    }
    if (agent == null) {
      throw new CLIValidationException(131,CloudifyErrorMessages.POST_BOOTSTRAP_NO_AGENT_FOUND.getName());
    }
    try {
      waitForManagementProcesses(agent,ShellUtils.millisUntil(TIMEOUT_ERROR_MESSAGE,end),TimeUnit.MILLISECONDS);
    }
 catch (    final Exception e) {
      throw new CLIValidationException(e,132,CloudifyErrorMessages.POST_BOOTSTRAP_MISSING_MGMT_COMPONENT.getName());
    }
    connectionLogs.supressConnectionErrors();
    try {
      for (      final AbstractManagementServiceInstaller managementServiceInstaller : managementServicesInstallers) {
        try {
          managementServiceInstaller.waitForInstallation(adminFacade,agent,ShellUtils.millisUntil(TIMEOUT_ERROR_MESSAGE,end),TimeUnit.MILLISECONDS);
        }
 catch (        Exception e) {
          throw new CLIValidationException(e,133,CloudifyErrorMessages.POST_BOOTSTRAP_MISSING_MGMT_SERVICE.getName(),managementServiceInstaller.getServiceName());
        }
      }
    }
  finally {
      connectionLogs.restoreConnectionErrors();
    }
  }
  finally {
    admin.close();
  }
}
