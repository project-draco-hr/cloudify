{
  final GSA gsa=((InternalGridServiceAgent)agent).getGSA();
  try {
    gsa.shutdown();
  }
 catch (  final RemoteException e) {
    if (!NetworkExceptionHelper.isConnectOrCloseException(e)) {
      logger.finer("Exception caught on teardown and not filtered. cause: " + e.getCause() + ", message: "+ e.getMessage()+ ", stacktrace:"+ e.getStackTrace());
      throw new AdminException("Failed to shutdown GSA",e);
    }
  }
  createConditionLatch(timeout,timeunit).waitFor(new ConditionLatch.Predicate(){
    /** 
 * Pings the agent to verify it's not available, indicating it was shut down.
 */
    @Override public boolean isDone() throws CLIException, InterruptedException {
      logger.info("Waiting for agent to shutdown");
      try {
        gsa.ping();
      }
 catch (      final RemoteException e) {
        return true;
      }
      return false;
    }
  }
);
}
