{
  File pemFile=null;
  if (this.management) {
    final String baseDirectory=Environment.getHomeDirectory();
    final File localDirectory=new File(baseDirectory,this.cloud.getProvider().getLocalDirectory());
    pemFile=new File(localDirectory,this.cloud.getUser().getKeyFile());
  }
 else {
    String localDirectoryName=this.cloud.getProvider().getLocalDirectory();
    logger.fine("local dir name is: " + localDirectoryName);
    final File localDirectory=new File(localDirectoryName);
    pemFile=new File(localDirectory,this.cloud.getUser().getKeyFile());
  }
  if (!pemFile.exists()) {
    logger.severe("Could not find pem file: " + pemFile);
    throw new FileNotFoundException("Could not find key file: " + pemFile);
  }
  logger.info("PEM file exists!");
  String password;
  if (cloudTemplate.getPassword() == null) {
    logger.info("Waiting for Windows Password to become available");
    final LoginCredentials credentials=new EC2WindowsPasswordHandler().getPassword(node,this.deployer.getContext(),end,pemFile);
    password=credentials.getPassword();
    logger.info("Windows Password retrieved");
  }
 else {
    password=cloudTemplate.getPassword();
  }
  String username=cloudTemplate.getUsername();
  if (username == null) {
    username=cloud.getConfiguration().getRemoteUsername();
  }
  if (username == null) {
    username=DEFAULT_EC2_WINDOWS_USERNAME;
  }
  machineDetails.setRemoteUsername(username);
  machineDetails.setRemotePassword(password);
  machineDetails.setFileTransferMode(cloudTemplate.getFileTransfer());
  machineDetails.setRemoteExecutionMode(cloudTemplate.getRemoteExecution());
}
