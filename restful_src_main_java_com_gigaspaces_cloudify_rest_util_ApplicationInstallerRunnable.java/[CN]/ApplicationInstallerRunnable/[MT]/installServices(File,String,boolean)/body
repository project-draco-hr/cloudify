{
  for (  final Service service : services) {
    service.getCustomProperties().put("usmJarPath",Environment.getHomeDirectory() + "/lib/platform/usm");
    final Properties contextProperties=createServiceContextProperties(service,applicationName,async);
    final String serviceName=service.getName();
    boolean found=false;
    try {
      File packedFile=Packager.pack(new File(appDir,serviceName));
      result.getApplicationFile().delete();
      packedFile.deleteOnExit();
      String absolutePUName=ServiceUtils.getAbsolutePUName(applicationName,serviceName);
      controller.deployElasticProcessingUnit(absolutePUName,applicationName,serviceName,packedFile,contextProperties);
      try {
        FileUtils.deleteDirectory(packedFile.getParentFile());
      }
 catch (      IOException ioe) {
        logger.warning("Failed to delete temporary directory: " + packedFile.getParentFile());
      }
      if (!async) {
        boolean instanceFound=controller.waitForServiceInstance(applicationName,serviceName,SERVICE_INSTANCE_STARTUP_TIMEOUT_MINUTES,TimeUnit.MINUTES);
        if (!instanceFound) {
          throw new TimeoutException("Service " + serviceName + " of application "+ applicationName+ " was installed, but no instance of the service has started after "+ SERVICE_INSTANCE_STARTUP_TIMEOUT_MINUTES+ " minutes.");
        }
      }
      found=true;
      logger.fine("service " + service + " deployed.");
    }
 catch (    Exception e) {
      logger.log(Level.SEVERE,"Failed to install service: " + serviceName + " of application: "+ applicationName+ ". Application installation will halt. "+ "Some services may already have started, and should be shutdown manually. Error was: "+ e.getMessage(),e);
      return;
    }
    if (!found) {
      logger.severe("Failed to find an instance of service: " + serviceName + " while installing application "+ applicationName+ ". Application installation will stop. Some services may have been installed!");
      return;
    }
  }
}
