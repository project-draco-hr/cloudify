{
  String userDn=user.getNameInNamespace();
  if (roleAttributes == null || roleAttributes.length == 0) {
    return Collections.emptySet();
  }
  Set<GrantedAuthority> authorities=new HashSet<GrantedAuthority>();
  if (logger.isDebugEnabled()) {
    logger.debug("Setting roles for user '" + username + "', DN = "+ "'"+ userDn+ " using attributes: "+ Arrays.toString(roleAttributes));
  }
  for (int i=0; i < roleAttributes.length; i++) {
    String[] rolesFromAttribute=user.getStringAttributes(roleAttributes[i]);
    if (rolesFromAttribute == null) {
      logger.debug("Couldn't read role attribute '" + roleAttributes[i] + "' for user "+ userDn);
      continue;
    }
    for (int j=0; j < rolesFromAttribute.length; j++) {
      GrantedAuthority authority=new GrantedAuthorityImpl(rolesFromAttribute[j]);
      authorities.add(authority);
    }
  }
  return authorities;
}
