{
  final GSA gsa=((InternalGridServiceAgent)agent).getGSA();
  try {
    gsa.shutdown();
  }
 catch (  RemoteException e) {
    if (!NetworkExceptionHelper.isConnectOrCloseException(e)) {
      throw new AdminException("Failed to shutdown GSA",e);
    }
  }
  createConditionLatch(timeout,timeunit).waitFor(new ConditionLatch.Predicate(){
    @Override public boolean isDone() throws CLIException, InterruptedException {
      logger.info("Waiting for agent to shutdown");
      try {
        gsa.ping();
      }
 catch (      RemoteException e) {
        return true;
      }
      return false;
    }
  }
);
}
