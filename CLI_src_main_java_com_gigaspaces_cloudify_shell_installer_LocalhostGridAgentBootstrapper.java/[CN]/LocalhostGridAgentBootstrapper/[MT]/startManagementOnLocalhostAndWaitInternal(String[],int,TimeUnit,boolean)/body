{
  long end=System.currentTimeMillis() + timeunit.toMillis(timeout);
  ConnectionLogsFilter connectionLogs=new ConnectionLogsFilter();
  connectionLogs.supressConnectionErrors();
  final Admin admin=createAdmin();
  try {
    setLookupDefaults(admin);
    GridServiceAgent agent;
    try {
      try {
        waitForExistingAgent(admin,progressInSeconds,TimeUnit.SECONDS);
        throw new CLIException("Agent already running on local machine.");
      }
 catch (      TimeoutException e) {
      }
      runGsAgentOnLocalHost("agent and management processes",gsAgentArgs);
      agent=waitForNewAgent(admin,ShellUtils.millisUntil(TIMEOUT_ERROR_MESSAGE,end),TimeUnit.MILLISECONDS);
    }
  finally {
      connectionLogs.restoreConnectionErrors();
    }
    waitForManagementProcesses(agent,ShellUtils.millisUntil(TIMEOUT_ERROR_MESSAGE,end),TimeUnit.MILLISECONDS);
    List<AbstractManagementServiceInstaller> waitForManagementServices=new LinkedList<AbstractManagementServiceInstaller>();
    connectionLogs.supressConnectionErrors();
    try {
      if (!noWebServices) {
        ManagementWebServiceInstaller webuiInstaller=new ManagementWebServiceInstaller();
        webuiInstaller.setAdmin(agent.getAdmin());
        webuiInstaller.setVerbose(verbose);
        webuiInstaller.setProgress(progressInSeconds,TimeUnit.SECONDS);
        webuiInstaller.setMemory(WEBUI_MEMORY_IN_MB,MemoryUnit.MEGABYTES);
        webuiInstaller.setPort(WEBUI_PORT);
        webuiInstaller.setWarFile(new File(WEBUI_FILE));
        webuiInstaller.setServiceName(WEBUI_NAME);
        webuiInstaller.setManagementZone(MANAGEMENT_GSA_ZONE);
        try {
          webuiInstaller.install();
        }
 catch (        ProcessingUnitAlreadyDeployedException e) {
          if (verbose) {
            logger.info("Service " + WEBUI_NAME + " already installed");
          }
        }
        if (waitForWebUi)         waitForManagementServices.add(webuiInstaller);
 else         webuiInstaller.logServiceLocation();
        ManagementWebServiceInstaller restInstaller=new ManagementWebServiceInstaller();
        restInstaller.setAdmin(agent.getAdmin());
        restInstaller.setProgress(progressInSeconds,TimeUnit.SECONDS);
        restInstaller.setVerbose(verbose);
        webuiInstaller.setProgress(progressInSeconds,TimeUnit.SECONDS);
        restInstaller.setMemory(REST_MEMORY_IN_MB,MemoryUnit.MEGABYTES);
        restInstaller.setPort(REST_PORT);
        restInstaller.setWarFile(new File(REST_FILE));
        restInstaller.setServiceName(REST_NAME);
        restInstaller.setManagementZone(MANAGEMENT_GSA_ZONE);
        restInstaller.setWaitForConnection();
        try {
          restInstaller.install();
        }
 catch (        ProcessingUnitAlreadyDeployedException e) {
          if (verbose) {
            logger.info("Service " + REST_NAME + " already installed");
          }
        }
        waitForManagementServices.add(restInstaller);
      }
      if (!noManagementSpace) {
        final boolean highlyAvailable=!isLocalCloud;
        ManagementSpaceServiceInstaller managementSpaceInstaller=new ManagementSpaceServiceInstaller();
        managementSpaceInstaller.setAdmin(agent.getAdmin());
        managementSpaceInstaller.setVerbose(verbose);
        managementSpaceInstaller.setMemory(MANAGEMENT_SPACE_MEMORY_IN_MB,MemoryUnit.MEGABYTES);
        managementSpaceInstaller.setServiceName(MANAGEMENT_SPACE_NAME);
        managementSpaceInstaller.setManagementZone(MANAGEMENT_GSA_ZONE);
        managementSpaceInstaller.setHighlyAvailable(highlyAvailable);
        try {
          managementSpaceInstaller.install();
          waitForManagementServices.add(managementSpaceInstaller);
        }
 catch (        ProcessingUnitAlreadyDeployedException e) {
          if (verbose) {
            logger.info("Service " + MANAGEMENT_SPACE_NAME + " already installed");
          }
        }
      }
      for (      AbstractManagementServiceInstaller managementServiceInstaller : waitForManagementServices) {
        managementServiceInstaller.waitForInstallation(adminFacade,agent,ShellUtils.millisUntil(TIMEOUT_ERROR_MESSAGE,end),TimeUnit.MILLISECONDS);
      }
    }
  finally {
      connectionLogs.restoreConnectionErrors();
    }
  }
  finally {
    admin.close();
  }
}
