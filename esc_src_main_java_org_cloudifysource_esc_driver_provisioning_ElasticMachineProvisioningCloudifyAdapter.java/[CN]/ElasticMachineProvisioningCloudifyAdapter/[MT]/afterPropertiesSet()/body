{
  final String cloudContents=properties.get(CloudifyConstants.ELASTIC_PROPERTIES_CLOUD_CONFIGURATION);
  if (cloudContents == null) {
    throw new IllegalArgumentException("Cloud configuration was not set!");
  }
  try {
    this.cloud=ServiceReader.readCloud(cloudContents);
    this.cloudTemplate=properties.get(CloudifyConstants.ELASTIC_PROPERTIES_CLOUD_TEMPLATE_NAME);
    if (this.cloudTemplate == null) {
      throw new BeanConfigurationException("Cloud template was not set!");
    }
    cloud.getProvider().setLocalDirectory(cloud.getProvider().getRemoteDirectory());
    try {
      this.cloudifyProvisioning=(ProvisioningDriver)Class.forName(this.cloud.getConfiguration().getClassName()).newInstance();
      this.cloudifyProvisioning.setConfig(cloud,cloudTemplate,false);
      if (cloudifyProvisioning instanceof ProvisioningDriverContextAware) {
        ProvisioningDriverContext provisioningDriverContext=lazyCreateProvisioningDriverContext(cloudifyProvisioning);
        ((ProvisioningDriverContextAware)cloudifyProvisioning).setProvisioningContext(provisioningDriverContext);
      }
    }
 catch (    ClassNotFoundException e) {
      throw new BeanConfigurationException("Failed to load provisioning class for cloud: " + this.cloud.getName() + ". Class not found: "+ this.cloud.getConfiguration().getClassName(),e);
    }
catch (    Exception e) {
      throw new BeanConfigurationException("Failed to load provisioning class for cloud: " + this.cloud.getName(),e);
    }
    this.lookupLocatorsString=createLocatorsString();
    logger.info("Locators string used for new instances will be: " + this.lookupLocatorsString);
  }
 catch (  DSLException e) {
    logger.severe("Could not parse the provided cloud configuration: " + cloudContents + ": "+ e.getMessage());
    throw new BeanConfigurationException("Could not parse the prvided cloud configuration: " + cloudContents + ": "+ e.getMessage());
  }
}
