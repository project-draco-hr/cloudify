{
  logger=java.util.logging.Logger.getLogger(ElasticMachineProvisioningCloudifyAdapter.class.getName());
  final String cloudConfigDirectoryPath=properties.get(CloudifyConstants.ELASTIC_PROPERTIES_CLOUD_CONFIGURATION_DIRECTORY);
  if (cloudConfigDirectoryPath == null) {
    logger.severe("Missing cloud configuration property. Properties are: " + this.properties);
    throw new IllegalArgumentException("Cloud configuration directory was not set!");
  }
  try {
    final String cloudOverridesPerService=config.getCloudOverridesPerService();
    this.cloud=ServiceReader.readCloudFromDirectory(cloudConfigDirectoryPath,cloudOverridesPerService);
    this.cloudTemplateName=properties.get(CloudifyConstants.ELASTIC_PROPERTIES_CLOUD_TEMPLATE_NAME);
    if (this.cloudTemplateName == null) {
      throw new BeanConfigurationException("Cloud template was not set!");
    }
    addTemplatesToCloud(new File(cloudConfigDirectoryPath));
    final ComputeTemplate cloudTemplate=this.cloud.getCloudCompute().getTemplates().get(this.cloudTemplateName);
    if (cloudTemplate == null) {
      throw new BeanConfigurationException("The provided cloud template name: " + this.cloudTemplateName + " was not found in the cloud configuration");
    }
    logger.info("Remote Directory is: " + cloudTemplate.getRemoteDirectory());
    if (cloudTemplate.getFileTransfer() == FileTransferModes.CIFS) {
      logger.info("Windows machine - modifying local directory location");
      final String remoteDirName=cloudTemplate.getRemoteDirectory();
      final String windowsLocalDirPath=getWindowsLocalDirPath(remoteDirName,cloudTemplate.getLocalDirectory());
      logger.info("Modified local dir name is: " + windowsLocalDirPath);
      cloudTemplate.setLocalDirectory(windowsLocalDirPath);
    }
 else {
      cloudTemplate.setLocalDirectory(cloudTemplate.getRemoteDirectory());
    }
    try {
      this.cloudifyProvisioning=(ProvisioningDriver)Class.forName(this.cloud.getConfiguration().getClassName()).newInstance();
      if (cloudifyProvisioning instanceof ProvisioningDriverClassContextAware) {
        final ProvisioningDriverClassContext provisioningDriverContext=lazyCreateProvisioningDriverClassContext(cloudifyProvisioning);
        final ProvisioningDriverClassContextAware contextAware=(ProvisioningDriverClassContextAware)cloudifyProvisioning;
        contextAware.setProvisioningDriverClassContext(provisioningDriverContext);
      }
      handleServiceCloudConfiguration();
      this.cloudifyProvisioning.setConfig(cloud,cloudTemplateName,false,serviceName);
    }
 catch (    final ClassNotFoundException e) {
      throw new BeanConfigurationException("Failed to load provisioning class for cloud: " + this.cloud.getName() + ". Class not found: "+ this.cloud.getConfiguration().getClassName(),e);
    }
catch (    final Exception e) {
      throw new BeanConfigurationException("Failed to load provisioning class for cloud: " + this.cloud.getName(),e);
    }
    this.lookupLocatorsString=createLocatorsString();
    logger.info("Locators string used for new instances will be: " + this.lookupLocatorsString);
  }
 catch (  final DSLException e) {
    logger.severe("Could not parse the provided cloud configuration from : " + cloudConfigDirectoryPath + ": "+ e.getMessage());
    throw new BeanConfigurationException("Could not parse the prvided cloud configuration: " + cloudConfigDirectoryPath + ": "+ e.getMessage(),e);
  }
}
