{
  logger=java.util.logging.Logger.getLogger(ElasticMachineProvisioningCloudifyAdapter.class.getName());
  final String cloudConfigDirectoryPath=findCloudConfigDirectoryPath();
  try {
    final String cloudOverridesPerService=config.getCloudOverridesPerService();
    initCloudObject(cloudConfigDirectoryPath,cloudOverridesPerService);
    this.cloudTemplateName=properties.get(CloudifyConstants.ELASTIC_PROPERTIES_CLOUD_TEMPLATE_NAME);
    if (this.cloudTemplateName == null) {
      throw new BeanConfigurationException("Cloud template was not set!");
    }
    addTemplatesToCloud(new File(cloudConfigDirectoryPath));
    final ComputeTemplate computeTemplate=this.cloud.getCloudCompute().getTemplates().get(this.cloudTemplateName);
    if (computeTemplate == null) {
      throw new BeanConfigurationException("The provided cloud template name: " + this.cloudTemplateName + " was not found in the cloud configuration");
    }
    logger.info("Remote Directory is: " + computeTemplate.getRemoteDirectory());
    if (computeTemplate.getFileTransfer() == FileTransferModes.CIFS) {
      logger.info("Windows machine - modifying local directory location");
      final String remoteDirName=computeTemplate.getRemoteDirectory();
      final String windowsLocalDirPath=getWindowsLocalDirPath(remoteDirName,computeTemplate.getLocalDirectory());
      logger.info("Modified local dir name is: " + windowsLocalDirPath);
      computeTemplate.setLocalDirectory(windowsLocalDirPath);
    }
 else {
      computeTemplate.setLocalDirectory(computeTemplate.getRemoteDirectory());
    }
    try {
      final ProvisioningDriverClassBuilder builder=new ProvisioningDriverClassBuilder();
      this.cloudifyProvisioning=builder.build(cloudConfigDirectoryPath,this.cloud.getConfiguration().getClassName());
      final ProvisioningDriverClassContext provisioningDriverContext=lazyCreateProvisioningDriverClassContext(cloudifyProvisioning);
      this.cloudifyProvisioning.setProvisioningDriverClassContext(provisioningDriverContext);
      handleServiceCloudConfiguration();
      final String storageClassName=this.cloud.getConfiguration().getStorageClassName();
      if (StringUtils.isNotBlank(storageClassName)) {
        logger.info("creating storage provisioning driver.");
        this.storageProvisioning=(StorageProvisioningDriver)Class.forName(storageClassName).newInstance();
        this.storageTemplateName=config.getStorageTemplateName();
        if (this.storageProvisioning instanceof BaseStorageDriver) {
          ((BaseStorageDriver)this.storageProvisioning).setComputeContext(cloudifyProvisioning.getComputeContext());
        }
        logger.info("storage provisioning driver created successfully.");
      }
    }
 catch (    final ClassNotFoundException e) {
      throw new BeanConfigurationException("Failed to load provisioning class for cloud: " + this.cloud.getName() + ". Class not found: "+ this.cloud.getConfiguration().getClassName(),e);
    }
catch (    final Exception e) {
      throw new BeanConfigurationException("Failed to load provisioning class for cloud: " + this.cloud.getName(),e);
    }
    this.lookupLocatorsString=createLocatorsString();
    logger.info("Locators string used for new instances will be: " + this.lookupLocatorsString);
  }
 catch (  final DSLException e) {
    logger.severe("Could not parse the provided cloud configuration from : " + cloudConfigDirectoryPath + ": "+ e.getMessage());
    throw new BeanConfigurationException("Could not parse the prvided cloud configuration: " + cloudConfigDirectoryPath + ": "+ e.getMessage(),e);
  }
}
