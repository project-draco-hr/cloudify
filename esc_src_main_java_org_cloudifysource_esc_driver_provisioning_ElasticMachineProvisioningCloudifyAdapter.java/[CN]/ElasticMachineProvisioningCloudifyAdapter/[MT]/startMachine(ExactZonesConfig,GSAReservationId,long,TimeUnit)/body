{
  logger.info("Cloudify Adapter is starting a new machine with zones " + zones.getZones() + " and reservation id "+ reservationId);
  final long end=System.currentTimeMillis() + unit.toMillis(duration);
  logger.info("Calling provisioning implementation for new machine");
  MachineDetails machineDetails;
  cloudifyProvisioning.setAdmin(getGlobalAdminInstance(originalESMAdmin));
  final ZonesConfig defaultZones=config.getGridServiceAgentZones();
  logger.fine("default zones = " + defaultZones.getZones());
  if (!defaultZones.isSatisfiedBy(zones)) {
    throw new IllegalArgumentException("The specified zones " + zones + " does not satisfy the configuration zones "+ defaultZones);
  }
  String locationId=null;
  logger.fine("searching for cloud specific zone");
  for (  final String zone : zones.getZones()) {
    logger.fine("current zone = " + zone);
    if (zone.startsWith(CLOUD_ZONE_PREFIX)) {
      logger.fine("found a zone with " + CLOUD_ZONE_PREFIX + " prefix : "+ zone);
      if (locationId == null) {
        locationId=zone.substring(CLOUD_ZONE_PREFIX.length());
        logger.fine("passing locationId to machine provisioning as " + locationId);
      }
 else {
        throw new IllegalArgumentException("The specified zones " + zones + " should include only one zone with the "+ CLOUD_ZONE_PREFIX+ " prefix:"+ locationId);
      }
    }
  }
  final MachineStartRequestedCloudifyEvent machineStartEvent=new MachineStartRequestedCloudifyEvent();
  machineStartEvent.setTemplateName(cloudTemplateName);
  machineStartEvent.setLocationId(locationId);
  machineEventListener.elasticMachineProvisioningProgressChanged(machineStartEvent);
  try {
    final ComputeTemplate template=cloud.getCloudCompute().getTemplates().get(this.cloudTemplateName);
    if (locationId == null) {
      locationId=template.getLocationId();
    }
    machineDetails=provisionMachine(locationId,duration,unit);
    validateMachineIp(machineDetails);
    if (machineDetails != null && machineDetails.getInstallerConfiguration() == null) {
      machineDetails.setInstallerConfigutation(template.getInstaller());
    }
  }
 catch (  final Exception e) {
    throw new ElasticMachineProvisioningException("Failed to provision machine: " + e.getMessage(),e);
  }
  logger.info("Machine was provisioned by implementation. Machine is: " + machineDetails);
  String machineIp;
  if (cloud.getConfiguration().isConnectToPrivateIp()) {
    machineIp=machineDetails.getPrivateAddress();
  }
 else {
    machineIp=machineDetails.getPublicAddress();
  }
  if (machineIp == null) {
    throw new IllegalStateException("The IP of the new machine is null! Machine Details are: " + machineDetails + " .");
  }
  final MachineStartedCloudifyEvent machineStartedEvent=new MachineStartedCloudifyEvent();
  machineStartedEvent.setMachineDetails(machineDetails);
  machineStartedEvent.setHostAddress(machineIp);
  machineEventListener.elasticMachineProvisioningProgressChanged(machineStartedEvent);
  final GridServiceAgentStartRequestedEvent agentStartEvent=new GridServiceAgentStartRequestedEvent();
  agentStartEvent.setHostAddress(machineIp);
  agentEventListener.elasticGridServiceAgentProvisioningProgressChanged(agentStartEvent);
  String volumeId=null;
  try {
    checkForProvisioningTimeout(end,machineDetails);
    if (machineDetails.isAgentRunning()) {
      logger.info("Machine provisioning provided a machine and indicated that an agent is already running");
    }
 else {
      logger.info("Cloudify Adapter is installing Cloudify agent with reservation id " + reservationId + " on "+ machineIp);
      installAndStartAgent(machineDetails,reservationId,end);
      checkForProvisioningTimeout(end,machineDetails);
    }
    logger.info("Cloudify adapter is waiting for GSA with reservation id " + reservationId + " to become available");
    final GridServiceAgent gsa=waitForGsa(machineIp,end);
    if (gsa == null) {
      throw new TimeoutException("New machine was provisioned and Cloudify was installed, " + "but a GSA was not discovered on the new machine: " + machineDetails);
    }
    final GSAReservationId discoveredReservationId=((InternalGridServiceAgent)gsa).getReservationId();
    logger.info("Discovered agent with reservation id " + discoveredReservationId);
    if (reservationId != null && !reservationId.equals(discoveredReservationId)) {
      throw new ElasticMachineProvisioningException("Cloudify Adapter discovered the wrong agent. expected reservation id is " + reservationId + ". but actual was "+ discoveredReservationId);
    }
    agentEventListener.elasticGridServiceAgentProvisioningProgressChanged(new GridServiceAgentStartedEvent(machineIp,gsa.getUid()));
    if (gsa.getVirtualMachine().getDetails().getEnvironmentVariables().get(CloudifyConstants.GIGASPACES_CLOUD_TEMPLATE_NAME) == null) {
      throw new ElasticGridServiceAgentProvisioningException("an agent was started. but the property " + CloudifyConstants.GIGASPACES_CLOUD_TEMPLATE_NAME + " was missing from its environment variables.");
    }
    return gsa;
  }
 catch (  final ElasticMachineProvisioningException e) {
    logger.info("ElasticMachineProvisioningException occurred, " + e.getMessage());
    logger.info(ExceptionUtils.getFullStackTrace(e));
    handleExceptionAfterMachineCreated(machineIp,volumeId,machineDetails,end);
    throw e;
  }
catch (  final ElasticGridServiceAgentProvisioningException e) {
    logger.info("ElasticGridServiceAgentProvisioningException occurred, " + e.getMessage());
    logger.info(ExceptionUtils.getFullStackTrace(e));
    handleExceptionAfterMachineCreated(machineIp,volumeId,machineDetails,end);
    throw e;
  }
catch (  final TimeoutException e) {
    logger.info("TimeoutException occurred, " + e.getMessage());
    logger.info(ExceptionUtils.getFullStackTrace(e));
    handleExceptionAfterMachineCreated(machineIp,volumeId,machineDetails,end);
    throw e;
  }
catch (  final InterruptedException e) {
    logger.info("InterruptedException occurred, " + e.getMessage());
    logger.info(ExceptionUtils.getFullStackTrace(e));
    handleExceptionAfterMachineCreated(machineIp,volumeId,machineDetails,end);
    throw e;
  }
catch (  final Throwable e) {
    logger.info("Unexpected exception occurred, " + e.getMessage());
    logger.info(ExceptionUtils.getFullStackTrace(e));
    handleExceptionAfterMachineCreated(machineIp,volumeId,machineDetails,end);
    throw new IllegalStateException("Unexpected exception during machine provisioning",e);
  }
}
