{
  DateFormat df=new SimpleDateFormat("_yyyy-MM-dd_hh-mm");
  int repeat=1;
  for (int i=1; i <= repeat; i++) {
    String filePattern="azuretest" + i + df.format(new Date())+ ".log";
    FileHandler fileHandler=new FileHandler(filePattern);
    fileHandler.setFormatter(new SimpleFormatter());
    logger.addHandler(fileHandler);
    logger.info("Starting test iteration #" + i);
    boolean failed=false;
    try {
      before();
      test();
    }
 catch (    Throwable t) {
      failed=true;
      throw t;
    }
 finally {
      if (failed) {
        logger.info("Failed test iteration #" + i + ". Machines are left running for manual diagnostics");
        logger.removeHandler(fileHandler);
        try {
          SimpleMail.send("Azure test failed\nSubscription ID=" + AZURE_SUBSCRIPTION_ID,new File(filePattern));
        }
 catch (        Exception e) {
          logger.log(Level.SEVERE,"Failed to send email",e);
        }
        break;
      }
 else {
        logger.info("Passed test iteration #" + i);
        logger.removeHandler(fileHandler);
        try {
          SimpleMail.send("Azure test passed\nSubscription ID=" + AZURE_SUBSCRIPTION_ID,new File(filePattern));
        }
 catch (        Exception e) {
          logger.log(Level.SEVERE,"Failed to send email",e);
        }
        after();
      }
    }
  }
}
