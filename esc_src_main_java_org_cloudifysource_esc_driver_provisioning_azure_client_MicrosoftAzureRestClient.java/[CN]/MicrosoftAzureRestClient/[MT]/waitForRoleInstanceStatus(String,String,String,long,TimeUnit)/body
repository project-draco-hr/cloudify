{
  long endTime=System.currentTimeMillis() + timeunit.toMillis(timeout);
  while (true) {
    Deployment deployment=getDeployment(hostedServiceName,deploymentSlot);
    String roleName=deployment.getRoleList().getRoles().get(0).getRoleName();
    String deploymentName=deployment.getName();
    String status=deployment.getRoleInstanceList().getRoleInstances().get(0).getInstanceStatus();
    boolean error=checkVirtualMachineStatusForError(status);
    if (error) {
      logger.warning("Virtual Machine " + roleName + " was provisioned but found in status "+ status);
      logger.warning("This role is unhealthy, deleting it");
      try {
        deleteRole(hostedServiceName,deploymentName,roleName,timeout,timeunit);
      }
 catch (      MicrosoftAzureException e) {
        logger.warning("Failed deleting role unhealthy role " + roleName);
        throw e;
      }
    }
    if (status.equals(state)) {
      return deployment;
    }
    if (System.currentTimeMillis() > endTime) {
      throw new TimeoutException("Timed out waiting for operation to finish. last state was : " + status);
    }
  }
}
