{
  long endTime=System.currentTimeMillis() + timeunit.toMillis(timeout);
  while (true) {
    Deployment deployment=getDeployment(hostedServiceName,deploymentSlot);
    String status=deployment.getStatus();
    if (status.equals(state)) {
      return deployment;
    }
    if (System.currentTimeMillis() > endTime) {
      throw new TimeoutException("Timed out waiting for operation to finish. last state was : " + status);
    }
  }
}
