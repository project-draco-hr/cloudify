{
  long endTime=System.currentTimeMillis() + timeunit.toMillis(timeout);
  while (true) {
    Operation operation=getOperation(requestId);
    String status=operation.getStatus();
    if (!status.equals(IN_PROGRESS)) {
      if (status.equals(SUCCEEDED)) {
        return;
      }
      if (status.equals(FAILED)) {
        String errorMessage=operation.getError().getMessage();
        throw new MicrosoftAzureException(errorMessage);
      }
    }
    if (System.currentTimeMillis() > endTime) {
      throw new TimeoutException("Timed out waiting for operation to finish. last state was : " + status);
    }
  }
}
