{
  final Map<String,Map<String,String>> failedToAddTempaltes=new HashMap<String,Map<String,String>>();
  final List<String> successfullyAddedTemplates=new LinkedList<String>();
  successfullyAddedTemplates.addAll(request.getExpectedTemplates());
  int failedHostCount=0;
  final ProcessingUnitInstance[] instances=admin.getProcessingUnits().waitFor("rest",RestUtils.TIMEOUT_IN_SECOND,TimeUnit.SECONDS).getInstances();
  log(Level.INFO,"[addTemplatesToRestInstances] - sending add templates request to " + instances.length + " instances.");
  for (  final ProcessingUnitInstance puInstance : instances) {
    final String port=Integer.toString(puInstance.getJeeDetails().getPort());
    String hostAddress=puInstance.getMachine().getHostAddress();
    log(Level.INFO,"[addTemplatesToRestInstances] - execute add-templates to " + hostAddress);
    final AddTemplatesInternalResponse instanceResponse=executeAddTemplateOnInstance(hostAddress,port,request);
    final Map<String,String> failedToAddTempaltesToHost=instanceResponse.getFailedToAddTempaltesAndReasons();
    if (failedToAddTempaltesToHost != null && !failedToAddTempaltesToHost.isEmpty()) {
      for (      final Entry<String,String> entry : failedToAddTempaltesToHost.entrySet()) {
        final String templateName=entry.getKey();
        final String reason=entry.getValue();
        successfullyAddedTemplates.remove(templateName);
        Map<String,String> templateFailedPUs=failedToAddTempaltes.get(templateName);
        if (templateFailedPUs == null) {
          templateFailedPUs=new HashMap<String,String>();
        }
        templateFailedPUs.put(hostAddress,reason);
        failedToAddTempaltes.put(templateName,templateFailedPUs);
      }
      final List<String> addedTempaltes=instanceResponse.getAddedTempaltes();
      log(Level.WARNING,"[addTemplatesToRestInstances] - failed to add templates to host [" + hostAddress + "]: "+ failedToAddTempaltesToHost);
      if (addedTempaltes == null || addedTempaltes.isEmpty()) {
        failedHostCount++;
      }
 else {
        log(Level.WARNING,"[addTemplatesToRestInstances] - successfully added templates: " + addedTempaltes);
      }
    }
 else {
      log(Level.INFO,"[addTemplatesToRestInstances] - successfully added templates to host [" + hostAddress + "].");
    }
  }
  if (instances.length == failedHostCount) {
    log(Level.WARNING,"[sendAddTemplatesToRestInstances] - Failed to add templates: " + failedToAddTempaltes);
    throw new RestErrorException(CloudifyErrorMessages.FAILED_TO_ADD_TEMPLATES.getName(),failedToAddTempaltes.toString());
  }
  final AddTemplatesResponse response=new AddTemplatesResponse();
  response.setFailedToAddTempaltes(failedToAddTempaltes);
  response.setSuccessfullyAddedTempaltes(successfullyAddedTemplates);
  return response;
}
