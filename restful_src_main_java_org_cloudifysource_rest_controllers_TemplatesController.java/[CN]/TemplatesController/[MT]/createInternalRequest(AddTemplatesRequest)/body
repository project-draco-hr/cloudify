{
  final String uploadKey=request.getUploadKey();
  final File templatesZippedFolder=repo.get(uploadKey);
  if (templatesZippedFolder == null) {
    throw new RestErrorException(CloudifyMessageKeys.WRONG_TEMPLATES_UPLOAD_KEY.getName(),uploadKey);
  }
  File templatesUnzippedFolder=null;
  try {
    templatesUnzippedFolder=new ComputeTemplatesReader().unzipCloudTemplatesFolder(templatesZippedFolder);
    final List<ComputeTemplateHolder> cloudTemplatesHolders=readCloudTemplates(templatesUnzippedFolder);
    final List<String> expectedAddedTemplates=readCloudTemplatesNames(templatesUnzippedFolder,cloudTemplatesHolders);
    AddTemplatesInternalRequest internalRequest=new AddTemplatesInternalRequest();
    internalRequest.setUploadKey(uploadKey);
    internalRequest.setCloudTemplates(cloudTemplatesHolders);
    internalRequest.setExpectedTemplates(expectedAddedTemplates);
    return internalRequest;
  }
  finally {
    FileUtils.deleteQuietly(templatesUnzippedFolder);
    FileUtils.deleteQuietly(templatesZippedFolder);
  }
}
