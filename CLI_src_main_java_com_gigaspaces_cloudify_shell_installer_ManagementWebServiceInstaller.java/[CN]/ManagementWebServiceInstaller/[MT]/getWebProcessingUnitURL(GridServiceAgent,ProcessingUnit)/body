{
  ProcessingUnitInstance pui=null;
  for (  ProcessingUnitInstance instance : pu.getInstances()) {
    if (instance.getGridServiceContainer() != null && instance.getGridServiceContainer().getGridServiceAgent() != null && instance.getGridServiceContainer().getGridServiceAgent().equals(agent)) {
      pui=instance;
    }
  }
  if (pui == null) {
    throw new IllegalStateException("Failed finding " + pu.getName() + " on "+ agent.getMachine().getHostAddress());
  }
  Map<String,ServiceDetails> alldetails=pui.getServiceDetailsByServiceId();
  ServiceDetails details=alldetails.get("jee-container");
  String host=details.getAttributes().get("host").toString();
  String port=details.getAttributes().get("port").toString();
  String ctx=details.getAttributes().get("context-path").toString();
  String url="http://" + host + ":"+ port+ ctx;
  try {
    return new URL(url);
  }
 catch (  MalformedURLException e) {
    throw new IllegalStateException(e);
  }
}
